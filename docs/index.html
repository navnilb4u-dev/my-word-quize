<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Flashcard Spelling Checker - Syllables</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  .flashcard { max-width: 400px; margin: auto; text-align: center; }
  .word { font-size: 2.5em; margin: 20px 0; }
  #counter { font-size: 1.2em; margin-bottom: 10px; }
  input[type="text"] { font-size: 1.4em; padding: 5px; width: 100%; }
  button { padding: 10px 20px; margin-top: 10px; font-size: 1em; }
  .result { margin-top: 15px; font-weight: bold; font-size: 1.3em; }
  .correct { color: green; }
  .incorrect { color: red; }
  #pronounceBreakdown { margin-top: 8px; font-size: 1.2em; font-weight: bold; color: #333; }
  .controls { margin-bottom: 20px; }
  .syllables { color: #0066cc; font-size: 1.3em; }
</style>
<!-- Load Hyphenator.js version 5.3.0 from cdnjs -->
<script src="cdnjs.cloudflare.com"></script>
</head>
<body>

<div class="flashcard">
  <div class="controls">
    <label for="pageSelect">Choose page: </label>
    <select id="pageSelect">
      <option value="0">Page 1</option>
      <option value="1">Page 2</option>
      <option value="2">Page 3</option>
    </select>
  </div>
  <div id="counter"></div>
  <div class="word" id="wordDisplay"></div>
  <button id="speakBtn">ðŸ”Š Listen</button>
  <input type="text" id="spellingInput" placeholder="Type the spelling here" autocomplete="off" />
  <button id="checkBtn">Check Spelling</button>
  <div class="result" id="resultDisplay"></div>
  <div id="pronounceBreakdown"></div>
  <button id="nextBtn" style="display:none;">Next Word</button>
</div>

<!-- All application JavaScript goes here -->
<script>
  const pages = [
    ["example", "language", "programming", "javascript", "flashcard", "geranium"],
    ["apple", "banana", "cherry", "date", "elderberry"],
    ["sun", "moon", "star", "planet", "galaxy"]
  ];

  let getSyllableBreakdown;
  let synth; // Reference to the speech synthesizer
  let voices = []; // Array to store available voices

  // Function to handle pronunciation
  function pronounceWord(word) {
    if (!('speechSynthesis' in window)) {
      alert('Speech synthesis not supported');
      return;
    }
    
    // Ensure voices are loaded before speaking
    if (voices.length === 0) {
        // If not loaded yet, try again when voices are ready
        window.speechSynthesis.onvoiceschanged = () => pronounceWord(word);
        return;
    }

    const utterance = new SpeechSynthesisUtterance(word);
    // Find a decent English voice or use the default
    const niceVoice = voices.find(v => v.lang.startsWith('en-US')) || voices[0];
    utterance.voice = niceVoice;
    utterance.rate = 0.9;
    utterance.pitch = 1.0;
    synth.speak(utterance);
  }

  // Listen for the specific event that the Hyphenator library fires when it is ready
  document.addEventListener('onhyphenatorready', function() {
      // Configure Hyphenator 5.3.0 with the correct properties
      Hyphenator.config({
          patterns: "cdnjs.cloudflare.com",
          hyphenchar: 'Â·',
          defaultLanguage: 'en',
          remoteResource: true
      });
      
      // Define our usable async function *after* config is set and the library is ready
      getSyllableBreakdown = async function(word) {
          return new Promise((resolve) => {
              Hyphenator.hyphenate(word, function(result) {
                  resolve(result);
              });
          });
      };
      
      // Re-run the start sequence now that hyphenation is ready
      startPage();
  });


  document.addEventListener('DOMContentLoaded', function() {
    synth = window.speechSynthesis;
    // Load voices immediately when the DOM loads
    voices = synth.getVoices();
    synth.onvoiceschanged = () => {
        voices = synth.getVoices();
    };


    const pageSelect = document.getElementById('pageSelect');
    const counter = document.getElementById('counter');
    const wordDisplay = document.getElementById('wordDisplay');
    const speakBtn = document.getElementById('speakBtn');
    const spellingInput = document.getElementById('spellingInput');
    const checkBtn = document.getElementById('checkBtn');
    const resultDisplay = document.getElementById('resultDisplay');
    const pronounceBreakdown = document.getElementById('pronounceBreakdown');
    const nextBtn = document.getElementById('nextBtn');

    let currentPage = 0;
    let words = [];
    let currentIndex = 0;

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function updateCounter() {
      counter.textContent = `Word ${currentIndex + 1} of ${words.length}`;
    }

    pageSelect.addEventListener('change', () => {
      currentPage = parseInt(pageSelect.value);
      startPage();
    });

    function showWord() {
      spellingInput.value = "";
      resultDisplay.innerHTML = "";
      resultDisplay.className = "result";
      pronounceBreakdown.textContent = "";
      nextBtn.style.display = "none";
      spellingInput.disabled = false;
      checkBtn.disabled = false;
      wordDisplay.textContent = "Spell this word:";
      updateCounter();
    }

    // Moved pronounceWord function definition outside DOMContentLoaded for scope access (above)

    speakBtn.addEventListener('click', () => {
      if (words[currentIndex]) {
        pronounceWord(words[currentIndex]);
      }
    });

    checkBtn.addEventListener('click', async () => {
      const userSpelling = spellingInput.value.trim().toLowerCase();
      const correctWord = words[currentIndex];

      // Safety check added here as requested (Line 172)
      if (correctWord && userSpelling === correctWord.toLowerCase()) { 
        resultDisplay.innerHTML = `Correct! The spelling is: <strong>${correctWord}</strong>`;
        resultDisplay.className = "result correct";
      } else if (correctWord) {
        resultDisplay.innerHTML = `Incorrect. The correct spelling is: <strong>${correctWord}</strong>`;
        resultDisplay.className = "result incorrect";
      }

      if (typeof getSyllableBreakdown === 'function') {
          const syllabified = await getSyllableBreakdown(correctWord);
          pronounceBreakdown.innerHTML = `<span class="syllables">${syllabified}</span>`;
      } else {
          pronounceBreakdown.innerHTML = "Hyphenation library not loaded yet.";
      }

      spellingInput.disabled = true;
      checkBtn.disabled = true;
      nextBtn.style.display = "inline-block";
    });

    nextBtn.addEventListener('click', () => {
      currentIndex++;
      if (currentIndex >= words.length) {
        startPage();
      } else {
        showWord();
      }
    });

    function startPage() {
      words = shuffle([...pages[currentPage]]);
      currentIndex = 0;
      showWord();
    }

    // startPage() removed from here, called by onhyphenatorready event instead
  });
</script>

</body>
</html>
